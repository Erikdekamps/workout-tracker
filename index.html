<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Workout Tracker</title>
  <style>
    /* --- CSS Variables & Theming --- */
    :root {
      --font-family-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      --color-background: #f0f2f5;
      --color-surface: #fff;
      --color-primary: #005fcc;
      --color-primary-hover: #004c99;
      --color-danger: #d92d20;
      --color-danger-hover: #b32318;
      --color-text-primary: #111827;
      --color-text-secondary: #6b7280;
      --color-border: #d1d5db;
      --color-input-bg: #f9fafb;
      --color-focus-ring: #005fcc;
      --color-dialog-backdrop: rgba(0, 0, 0, 0.5);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --color-background: #111827;
        --color-surface: #1f2937;
        --color-primary: #3b82f6;
        --color-primary-hover: #2563eb;
        --color-danger: #f87171;
        --color-danger-hover: #ef4444;
        --color-text-primary: #f9fafb;
        --color-text-secondary: #9ca3af;
        --color-border: #374151;
        --color-input-bg: #374151;
        --color-focus-ring: #3b82f6;
        --color-dialog-backdrop: rgba(0, 0, 0, 0.7);
      }
    }

    /* --- Global Styles & Resets --- */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      font-size: 100%;
    }

    body {
      font-family: var(--font-family-sans);
      background-color: var(--color-background);
      color: var(--color-text-primary);
      line-height: 1.5;
    }

    /* --- Accessibility & Utilities --- */
    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    *:focus-visible {
      outline: 2px solid var(--color-focus-ring);
      outline-offset: 2px;
    }

    /* --- Layout --- */
    .container {
      max-width: 800px;
      margin-inline: auto;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    /* --- Components --- */
    .header__title {
      font-size: 2.25rem;
      text-align: center;
    }

    .tabs__list {
      display: flex;
      list-style: none;
      border-bottom: 2px solid var(--color-border);
    }

    .tabs__item {
      flex: 1;
    }

    .tabs__button {
      width: 100%;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      color: var(--color-text-secondary);
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      margin-bottom: -2px;
      transition: color 150ms ease, border-color 150ms ease;
    }

    .tabs__button[aria-selected="true"] {
      color: var(--color-primary);
      border-color: var(--color-primary);
    }

    .panel {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .panel[hidden] {
      display: none;
    }

    .card {
      background-color: var(--color-surface);
      padding: 1.5rem;
      border: 1px solid var(--color-border);
      box-shadow: none;
    }

    .card__title-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .card__title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
    }

    .card__title-container .card__title {
      margin-bottom: 0;
    }

    .button {
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: background-color 150ms ease;
      text-align: center;
      line-height: 1;
    }

    .button--primary {
      background-color: var(--color-primary);
      color: #fff;
    }

    .button--primary:hover {
      background-color: var(--color-primary-hover);
    }

    .button--danger {
      background-color: var(--color-danger);
      color: #fff;
    }

    .button--danger:hover {
      background-color: var(--color-danger-hover);
    }

    .button--secondary {
      background: transparent;
      color: var(--color-text-primary);
      border: 1px solid var(--color-border);
    }

    .button--secondary:hover {
      background-color: var(--color-input-bg);
    }

    .button--icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 2.25rem;
      height: 2.25rem;
      padding: 0;
      line-height: 0;
      color: var(--color-text-secondary);
      background: transparent;
    }

    .button--icon:hover {
      color: var(--color-text-primary);
    }

    .button--icon.button--danger-hover:hover {
      background-color: rgba(217, 45, 32, 0.1);
      color: var(--color-danger);
    }

    .form {
      display: grid;
      gap: 1rem;
    }

    @media (min-width: 640px) {
      .form--log.grid-cols-3 {
        grid-template-columns: 2fr 1fr 1fr;
      }

      .form--log.grid-cols-2 {
        grid-template-columns: 2fr 1fr;
      }

      .form--log {
        align-items: flex-end;
      }
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .form-group[hidden] {
      display: none;
    }

    .form-group--full-width {
      grid-column: 1 / -1;
    }

    .form-group__label {
      font-weight: 500;
    }

    .input,
    select,
    textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      font-size: 1rem;
      font-family: inherit;
      background-color: var(--color-input-bg);
      border: 1px solid var(--color-border);
      color: var(--color-text-primary);
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }

    select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%236b7280' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 1rem;
      padding-right: 2.5rem;
      cursor: pointer;
    }

    @media (prefers-color-scheme: dark) {
      select {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%239ca3af' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
      }
    }

    select:focus-visible {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23005fcc' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
    }

    @media (prefers-color-scheme: dark) {
      select:focus-visible {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%233b82f6' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
      }
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    .collapsible-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .collapsible-list details {
      border: 1px solid var(--color-border);
      overflow: hidden;
    }

    .collapsible-group__summary {
      padding: 1rem 1.5rem;
      font-weight: 600;
      cursor: pointer;
      background-color: var(--color-surface);
      list-style: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .collapsible-group__summary::-webkit-details-marker {
      display: none;
    }

    .collapsible-group__summary::after {
      content: '';
      display: inline-block;
      width: 0.5em;
      height: 0.5em;
      border-style: solid;
      border-color: currentColor;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
      transition: transform 0.2s ease-in-out;
      flex-shrink: 0;
      margin-top: 0.1em;
    }

    details[open]>.collapsible-group__summary::after {
      transform: rotate(-135deg);
      margin-top: 0.3em;
    }

    details[open]>.collapsible-group__summary {
      border-bottom: 1px solid var(--color-border);
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
    }

    .collapsible-group__list {
      list-style: none;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      background-color: var(--color-background);
    }

    .exercise-list__item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: var(--color-surface);
      padding: 0.5rem 0.5rem 0.5rem 1rem;
      border: 1px solid var(--color-border);
      gap: 1rem;
    }

    .exercise-list__item-main {
      flex-grow: 1;
    }

    .exercise-list__edit-fields {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      flex-grow: 1;
      width: 100%;
    }

    .exercise-list__actions {
      display: flex;
      gap: 0.25rem;
      flex-shrink: 0;
    }

    .exercise-list__name {
      font-weight: 600;
    }

    .history-list__item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: var(--color-surface);
      padding: 1rem;
      border: 1px solid var(--color-border);
      gap: 0.5rem 1rem;
      flex-wrap: wrap;
    }

    .history-list__details {
      display: flex;
      flex-direction: column;
    }

    .history-list__exercise {
      font-weight: 600;
    }

    .history-list__meta {
      color: var(--color-text-secondary);
      font-size: 0.875rem;
    }

    .history-list__time {
      color: var(--color-text-secondary);
      font-size: 0.875rem;
      text-align: right;
      flex-shrink: 0;
      margin-left: auto;
    }

    .dialog {
      max-width: 500px;
      width: 90%;
      border: 1px solid var(--color-border);
      background-color: var(--color-surface);
      color: var(--color-text-primary);
      box-shadow: var(--shadow-md);
      padding: 1.5rem;
    }

    .dialog::backdrop {
      background-color: var(--color-dialog-backdrop);
      -webkit-backdrop-filter: blur(2px);
      backdrop-filter: blur(2px);
    }

    .dialog__title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
    }

    .dialog__message {
      margin-bottom: 1.5rem;
      color: var(--color-text-secondary);
    }

    .dialog__actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
    }

    .card__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .card__header .card__title {
      margin: 0;
    }

    .dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown__toggle {
      background: none;
      border: none;
      padding: 0.5rem;
      cursor: pointer;
      color: var(--color-text);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s;
    }

    .dropdown__toggle:hover {
      background-color: var(--color-surface);
    }

    .dropdown__menu {
      position: absolute;
      right: 0;
      top: 100%;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      min-width: 200px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 10000;
      margin-top: 0.25rem;
      display: none;
    }

    .dropdown__menu.show {
      display: block;
    }

    .dropdown__item {
      display: block;
      width: 100%;
      padding: 0.75rem 1rem;
      text-align: left;
      border: none;
      background: none;
      color: var(--color-text);
      cursor: pointer;
      transition: background-color 0.2s;
      font-size: 0.875rem;
    }

    .dropdown__item:hover {
      background-color: var(--color-surface);
    }

    .dropdown__item--danger:hover {
      background-color: #fee;
      color: #c00;
    }

    /* --- Quality of Life Features --- */
    .rest-timer {
      position: relative;
      width: 100%;
      max-width: 100%;
      background-color: var(--color-surface);
      border: 1px solid var(--color-border);
      box-shadow: none;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-sizing: border-box;
    }

    .rest-timer.collapsed {
      padding: 0;
    }

    .rest-timer.collapsed .rest-timer__toggle {
      padding: 1rem 1.5rem;
    }

    .rest-timer.expanded {
      padding: 0;
    }

    .rest-timer.expanded .rest-timer__toggle {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--color-border);
    }

    .rest-timer__toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--color-text);
      transition: background-color 0.2s ease;
      font-size: 1rem;
      font-weight: 600;
      text-align: left;
      box-sizing: border-box;
      gap: 1rem;
    }

    .rest-timer__toggle:hover {
      background-color: var(--color-background);
    }

    .rest-timer__toggle-text {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-grow: 1;
    }

    .rest-timer__toggle-label::after {
      content: 'Rest Timer';
    }

    .rest-timer__toggle-time {
      font-variant-numeric: tabular-nums;
      color: var(--color-primary);
      font-weight: 700;
    }

    .rest-timer.collapsed .rest-timer__toggle-time {
      display: inline;
    }

    .rest-timer.expanded .rest-timer__toggle-time {
      display: none;
    }

    .rest-timer.collapsed .rest-timer__content {
      display: none;
      opacity: 0;
    }

    .rest-timer.expanded .rest-timer__content {
      display: block;
      opacity: 1;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .rest-timer__toggle svg {
      transition: transform 0.3s ease;
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }

    .rest-timer.collapsed .rest-timer__toggle svg {
      transform: rotate(0deg);
    }

    .rest-timer.expanded .rest-timer__toggle svg {
      transform: rotate(180deg);
    }

    .rest-timer__content {
      padding: 1.5rem;
      transition: opacity 0.3s ease;
    }

    .rest-timer__display-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .rest-timer__adjust-btn {
      width: 36px;
      height: 36px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      font-weight: 700;
      flex-shrink: 0;
    }

    .rest-timer__display {
      font-size: 2rem;
      font-weight: 700;
      text-align: center;
      color: var(--color-primary);
      font-variant-numeric: tabular-nums;
      min-width: 100px;
    }

    .rest-timer__display.warning {
      color: #f59e0b;
    }

    .rest-timer__display.complete {
      color: #10b981;
    }

    .rest-timer__controls {
      display: flex;
      gap: 0.5rem;
    }

    .rest-timer__controls .button {
      flex: 1;
      padding: 0.5rem;
      font-size: 0.875rem;
    }

    @media (max-width: 640px) {
      .rest-timer.collapsed .rest-timer__toggle {
        padding: 0.875rem 1rem;
        font-size: 0.9375rem;
      }

      .rest-timer.expanded .rest-timer__toggle {
        padding: 0.875rem 1rem;
      }

      .rest-timer.expanded .rest-timer__content {
        padding: 1rem;
      }

      .rest-timer__toggle svg {
        width: 18px;
        height: 18px;
      }
    }
  </style>
</head>

<body>
  <div class="visually-hidden" id="announcer" role="log" aria-live="assertive" aria-atomic="true"></div>
  <div class="container">
    <header class="header">
      <h1 class="header__title">Workout Tracker</h1>
    </header>
    <main>
      <nav class="tabs" aria-label="Main navigation">
        <ul class="tabs__list" role="tablist">
          <li class="tabs__item" role="presentation">
            <button class="tabs__button" role="tab" id="log-tab" aria-controls="log-panel">Log Workout</button>
          </li>
          <li class="tabs__item" role="presentation">
            <button class="tabs__button" role="tab" id="settings-tab" aria-controls="settings-panel">Manage
              Exercises</button>
          </li>
        </ul>
      </nav>
      <section id="log-panel" class="panel" role="tabpanel" aria-labelledby="log-tab">
        <div class="card">
          <h2 class="card__title" id="log-form-title">Log an Activity</h2>
          <form id="log-form" class="form form--log" novalidate aria-labelledby="log-form-title">
            <div class="form-group">
              <label for="log-exercise" class="form-group__label">Exercise</label><select id="log-exercise"
                class="input" name="exerciseId" required></select>
            </div>
            <div class="form-group" id="log-weight-group" hidden>
              <label for="log-weight" class="form-group__label">Weight (kg)</label><input type="number" id="log-weight"
                class="input" name="weight" min="0" step="0.5" placeholder="20" pattern="[0-9]*" inputmode="numeric">
            </div>
            <div class="form-group" id="log-reps-group" hidden>
              <label for="log-reps" class="form-group__label">Reps</label><input type="number" id="log-reps"
                class="input" name="reps" min="1" step="1" placeholder="10" pattern="[0-9]*" inputmode="numeric">
            </div>
            <div class="form-group" id="log-distance-group" hidden>
              <label for="log-distance" class="form-group__label">Distance (km)</label><input type="number"
                id="log-distance" class="input" name="distance" min="0" step="0.1" placeholder="5" pattern="[0-9]*" inputmode="numeric">
            </div>
            <div class="form-group" id="log-duration-group" hidden>
              <label for="log-duration" class="form-group__label">Duration</label><input type="number" id="log-duration"
                class="input" name="duration" min="1" step="1" placeholder="30" pattern="[0-9]*" inputmode="numeric">
            </div>
            <button type="submit" class="button button--primary form-group--full-width">Log Activity</button>
          </form>
        </div>

        <!-- Rest Timer -->
        <div id="rest-timer" class="rest-timer collapsed">
          <button class="rest-timer__toggle" id="rest-timer-toggle" aria-label="Toggle rest timer" aria-expanded="false">
            <span class="rest-timer__toggle-text">
              <span class="rest-timer__toggle-label"></span>
              <span class="rest-timer__toggle-time" id="rest-timer-toggle-display">1:00</span>
            </span>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
              <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708"/>
            </svg>
          </button>
          <div class="rest-timer__content">
            <div class="rest-timer__display-container">
              <button id="rest-timer-decrease" class="button button--secondary rest-timer__adjust-btn" aria-label="Decrease time by 10 seconds">−</button>
              <div class="rest-timer__display" id="rest-timer-display">1:00</div>
              <button id="rest-timer-increase" class="button button--secondary rest-timer__adjust-btn" aria-label="Increase time by 10 seconds">+</button>
            </div>
            <div class="rest-timer__controls">
              <button id="rest-timer-pause" class="button button--secondary">Start</button>
              <button id="rest-timer-reset" class="button button--secondary">Reset</button>
            </div>
          </div>
        </div>

        <div class="card" id="history-card">
          <h2 class="card__title" id="history-title">History</h2>
          <div id="history-container" role="feed" aria-busy="false">
            <div id="history-list" class="collapsible-list"></div>
            <p id="history-empty-state">No activities logged yet. Let's get to work!</p>
          </div>
        </div>
      </section>
      <section id="settings-panel" class="panel" role="tabpanel" aria-labelledby="settings-tab" hidden>
        <div class="card">
          <h2 class="card__title" id="add-exercise-title">Add New Exercise</h2>
          <form id="add-exercise-form" class="form" novalidate aria-labelledby="add-exercise-title">
            <div class="form-group form-group--full-width">
              <label for="new-exercise-name" class="form-group__label">Exercise Name</label><input type="text"
                id="new-exercise-name" class="input" required placeholder="Filter or add new exercise...">
            </div>
            <div class="form-group">
              <label for="new-exercise-category" class="form-group__label">Category</label><select
                id="new-exercise-category" class="input" required></select>
            </div>
            <div class="form-group">
              <label for="new-exercise-type" class="form-group__label">Exercise Type</label><select
                id="new-exercise-type" class="input" required></select>
            </div>
            <div class="form-group form-group--full-width">
              <label for="new-exercise-notes" class="form-group__label">Notes (Optional)</label><textarea
                id="new-exercise-notes" class="input"
                placeholder="e.g., Proper form cues, machine number..."></textarea>
            </div>
            <button type="submit" class="button button--primary form-group--full-width">Add Exercise</button>
          </form>
        </div>
        <div class="card">
          <div class="card__header">
            <h2 class="card__title">Manage Exercises</h2>
            <div class="dropdown">
              <button class="dropdown__toggle" id="manage-exercises-menu-toggle" aria-label="Exercise options menu" aria-expanded="false">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3"/>
                </svg>
              </button>
              <div class="dropdown__menu" id="manage-exercises-menu">
                <button class="dropdown__item dropdown__item--danger" id="reset-exercises-btn">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 0.5rem; vertical-align: middle;">
                    <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                    <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>
                  </svg>
                  Reset to Defaults
                </button>
              </div>
            </div>
          </div>
          <div id="manage-exercise-list" class="collapsible-list"></div>
          <p id="manage-exercise-empty-state" hidden>No exercises match your filter.</p>
        </div>
      </section>

    </main>
  </div>
  <dialog id="confirmation-dialog" class="dialog">
    <h3 class="dialog__title" id="dialog-title">Confirm Action</h3>
    <p class="dialog__message" id="dialog-message"></p>
    <div class="dialog__actions">
      <button class="button button--secondary" id="dialog-cancel-btn">Cancel</button>
      <button class="button button--danger" id="dialog-confirm-btn">Confirm</button>
    </div>
  </dialog>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ===================================================================================
      // STATE MODULE
      // ===================================================================================
      const State = {
        _data: {},
        _defaults: {
          activeTab: 'log', exercises: [], history: [],
          logForm: { exerciseId: '', weight: '', reps: '', distance: '', duration: '' },
          settings: { filter: '', editingExerciseId: null, editingCategory: null, keepCategoryOpen: null },
          restTimer: { running: false, paused: false, startTime: 0, remaining: 60, duration: 60, expanded: false }
        },
        _constants: {
          STORAGE_KEY: 'workoutTrackerState_v5',
          EXERCISE_CATEGORIES: [
            'Abs',
            'Back', 
            'Biceps',
            'Calves',
            'Cardio',
            'Chest', 
            'Core',
            'Forearms',
            'Full Body',
            'Functional',
            'Glutes',
            'Hamstrings',
            'Legs', 
            'Lower Back',
            'Mobility',
            'Obliques',
            'Olympic Lifts',
            'Other',
            'Pilates',
            'Plyometrics',
            'Quadriceps',
            'Shoulders', 
            'Sports',
            'Stretching',
            'Traps',
            'Triceps',
            'Yoga'
          ],
          EXERCISE_TYPES: {
            WEIGHT_REPS: { id: 'weight_reps', label: 'Weight & Reps' }, REPS_ONLY: { id: 'reps_only', label: 'Reps Only' },
            TIMED: { id: 'timed', label: 'Timed (e.g., Plank)' }, DISTANCE_TIME: { id: 'distance_time', label: 'Distance & Time' }
          }
        },

        init() { this._data = this._load(); },

        _load() {
          try {
            const storedState = localStorage.getItem(this._constants.STORAGE_KEY);
            if (!storedState) {
              return this._getInitialState();
            }
            let parsedState = JSON.parse(storedState);
            if (parsedState.exercises && parsedState.exercises.length > 0 && !parsedState.exercises[0].type) {
              parsedState.exercises = this._migrateExercises(parsedState.exercises);
            }
            const allIds = [
              ...(parsedState.exercises || []).map(item => parseInt(item.id.split('-')[1])),
              ...(parsedState.history || []).map(item => parseInt(item.id.split('-')[1]))
            ].filter(Boolean);
            const nextId = (allIds.length > 0 ? Math.max(...allIds) : 0) + 1;
            const initialState = this._getInitialState(nextId);
            const mergedState = { ...initialState, ...parsedState };
            
            // Ensure restTimer has remaining property initialized
            if (mergedState.restTimer && !mergedState.restTimer.hasOwnProperty('remaining')) {
              mergedState.restTimer.remaining = mergedState.restTimer.duration || 60;
            }
            
            return mergedState;
          } catch (error) {
            console.error('Failed to load state, falling back to defaults.', error);
            return this._getInitialState();
          }
        },

        save() {
          const stateToSave = {
            exercises: this._data.exercises, history: this._data.history,
            activeTab: this._data.activeTab, logForm: { exerciseId: this._data.logForm.exerciseId },
            restTimer: this._data.restTimer
          };
          localStorage.setItem(this._constants.STORAGE_KEY, JSON.stringify(stateToSave));
        },

        _getInitialState(startId = 1) {
          let nextId = startId;
          const generateId = (prefix) => `${prefix}-${nextId++}`;
          const { WEIGHT_REPS, REPS_ONLY, TIMED, DISTANCE_TIME } = this._constants.EXERCISE_TYPES;
          
          // Helper to create exercise object with auto-generated ID
          const ex = (name, category, type, notes = '') => ({ 
            id: generateId('ex'), 
            name, 
            category, 
            type, 
            notes 
          });
          
          const defaultExercises = [
            // Abs
            ex('Ab Crunch Machine', 'Abs', WEIGHT_REPS.id, 'Sit in machine, hold handles, crunch torso down by contracting abs. Keep lower back pressed against pad.'),
            ex('Ab Roller', 'Abs', REPS_ONLY.id, 'Kneel on floor, grip roller handles. Roll forward extending arms fully while keeping core tight. Roll back to start.'),
            ex('Cable Crunches (Abs)', 'Abs', WEIGHT_REPS.id, 'Kneel facing cable machine, hold rope attachment at head level. Crunch down by contracting abs, elbows to knees.'),
            ex('Decline Crunches', 'Abs', REPS_ONLY.id, 'Lie on decline bench, feet secured. Place hands behind head, crunch up by contracting abs. Lower with control.'),
            ex('Dragon Flags', 'Abs', REPS_ONLY.id, 'Lie on bench, grip bench by head. Raise entire body up keeping straight, lower slowly. Advanced core exercise.'),
            ex('Hanging Knee Raises', 'Abs', REPS_ONLY.id, 'Hang from pull-up bar with straight arms. Raise knees to chest by contracting abs. Lower with control.'),
            ex('Hollow Body Hold', 'Abs', TIMED.id, 'Lie on back, raise shoulders and legs off ground. Press lower back into floor, hold position with arms extended.'),
            ex('Toes to Bar', 'Abs', REPS_ONLY.id, 'Hang from pull-up bar. Swing legs up to touch toes to bar using abs. Lower with control. Advanced movement.'),
            
            // Back
            ex('Assisted Pull-ups', 'Back', REPS_ONLY.id, 'Use assisted pull-up machine. Grip bar wide, pull body up until chin over bar. Lower with control.'),
            ex('Barbell Row', 'Back', WEIGHT_REPS.id, 'Bend at hips, grip barbell. Pull bar to lower chest, squeeze shoulder blades. Lower with control.'),
            ex('Chin-ups', 'Back', REPS_ONLY.id, 'Grip bar with palms facing you (underhand). Pull up until chin over bar. Lower fully. Emphasizes biceps and lats.'),
            ex('Close Grip Lat Pulldown', 'Back', WEIGHT_REPS.id, 'Sit at lat pulldown machine with narrow grip. Pull bar to upper chest, squeeze lats. Return slowly.'),
            ex('Deadlift', 'Back', WEIGHT_REPS.id, 'Stand with barbell over mid-foot. Grip bar, keep back straight, drive through heels to stand. Lower with control.'),
            ex('Dumbbell Row', 'Back', WEIGHT_REPS.id, 'Support body on bench, row dumbbell to hip. Keep elbow close, squeeze shoulder blade at top. Alternate arms.'),
            ex('Face Pulls', 'Back', WEIGHT_REPS.id, 'Use rope attachment at face height. Pull rope toward face, separate hands. Focus on rear delts and upper back.'),
            ex('Hyperextensions', 'Back', REPS_ONLY.id, 'Position on hyperextension bench, lower torso down. Raise back up to parallel. Focus on lower back and glutes.'),
            ex('Inverted Rows', 'Back', REPS_ONLY.id, 'Lie under low bar, pull chest to bar. Keep body straight. Great bodyweight back exercise.'),
            ex('Lat Pulldown', 'Back', WEIGHT_REPS.id, 'Sit at machine, grip bar wide. Pull bar to upper chest, lean back slightly. Squeeze lats, return slowly.'),
            ex('Pull-ups', 'Back', REPS_ONLY.id, 'Grip bar with palms away (overhand). Pull body up until chin over bar. Lower fully with control.'),
            ex('Seated Cable Row', 'Back', WEIGHT_REPS.id, 'Sit at cable row machine, feet braced. Pull handle to torso, squeeze shoulder blades. Return with control.'),
            ex('T-Bar Row', 'Back', WEIGHT_REPS.id, 'Straddle T-bar, bend at hips. Pull bar to chest, squeeze back. Lower with control. Keep back straight.'),
            
            // Biceps
            ex('Barbell Curl', 'Biceps', WEIGHT_REPS.id, 'Stand with barbell, arms extended. Curl bar to shoulders, keeping elbows still. Lower with control.'),
            ex('Cable Curl', 'Biceps', WEIGHT_REPS.id, 'Stand at cable machine with bar attachment. Curl bar up, squeeze biceps at top. Lower slowly.'),
            ex('Concentration Curl', 'Biceps', WEIGHT_REPS.id, 'Sit, brace elbow on inner thigh. Curl dumbbell up to shoulder, focus on bicep contraction. Lower slowly.'),
            ex('Dumbbell Curl', 'Biceps', WEIGHT_REPS.id, 'Stand with dumbbells at sides. Curl up rotating palms to face shoulders. Can alternate arms or do together.'),
            ex('EZ Bar Curl', 'Biceps', WEIGHT_REPS.id, 'Grip angled EZ bar. Curl up to shoulders, elbows stationary. Angled grip reduces wrist strain.'),
            ex('Hammer Curl', 'Biceps', WEIGHT_REPS.id, 'Hold dumbbells with neutral grip (palms facing each other). Curl up keeping thumbs up. Works brachialis.'),
            ex('Incline Dumbbell Curl', 'Biceps', WEIGHT_REPS.id, 'Lie back on incline bench, arms hanging. Curl dumbbells up, allowing full stretch at bottom. Longer range of motion.'),
            ex('Preacher Curl', 'Biceps', WEIGHT_REPS.id, 'Position arms on preacher bench pad. Curl weight up, squeeze at top. Lower slowly. Isolates biceps.'),
            
            // Calves
            ex('Calf Raise on Leg Press', 'Calves', WEIGHT_REPS.id, 'Position feet on leg press platform. Push through balls of feet to raise heels. Lower for full stretch.'),
            ex('Donkey Calf Raise', 'Calves', WEIGHT_REPS.id, 'Bend at hips with weight on lower back. Rise onto toes, stretch calves. Lower heels below platform.'),
            ex('Jump Rope (Calf Focus)', 'Calves', TIMED.id, 'Jump rope staying on balls of feet. Keep bounces small and quick. Great for calf endurance and definition.'),
            ex('Seated Calf Raise', 'Calves', WEIGHT_REPS.id, 'Sit at machine with knees under pad. Push through balls of feet to raise heels. Targets soleus muscle.'),
            ex('Single Leg Calf Raise', 'Calves', REPS_ONLY.id, 'Stand on one leg, hold for balance. Rise onto toes, squeeze calf. Lower heel below step. Bodyweight only.'),
            ex('Standing Calf Raise', 'Calves', WEIGHT_REPS.id, 'Stand on calf raise machine or Smith machine. Rise onto toes, squeeze calves. Lower heels for stretch.'),
            
            // Cardio
            ex('Burpees', 'Cardio', REPS_ONLY.id, 'Drop to plank, do push-up, jump feet to hands, jump up. Full body explosive cardio movement.'),
            ex('Cycling', 'Cardio', DISTANCE_TIME.id, 'Pedal on road bike or stationary bike. Maintain steady pace or interval training. Track distance and time.'),
            ex('Elliptical', 'Cardio', TIMED.id, 'Use elliptical machine with smooth motion. Can adjust resistance and incline. Low impact cardio option.'),
            ex('High Knees', 'Cardio', TIMED.id, 'Run in place bringing knees to waist height. Keep core tight, arms pumping. High intensity cardio.'),
            ex('Jump Rope', 'Cardio', TIMED.id, 'Jump with rope, landing on balls of feet. Keep jumps small and quick. Great cardio and coordination.'),
            ex('Mountain Climbers', 'Cardio', TIMED.id, 'Start in plank position. Alternate driving knees to chest rapidly. Keep core engaged throughout.'),
            ex('Rowing Machine', 'Cardio', DISTANCE_TIME.id, 'Push with legs, pull handle to chest, return. Full body cardio. Track distance and time.'),
            ex('Running', 'Cardio', DISTANCE_TIME.id, 'Run outdoors or on treadmill. Maintain steady pace or interval training. Track distance and time.'),
            ex('Stair Climber', 'Cardio', TIMED.id, 'Step on machine maintaining good posture. Can adjust speed and resistance. Great for legs and cardio.'),
            ex('Swimming', 'Cardio', DISTANCE_TIME.id, 'Swim laps using any stroke. Low impact full body cardio. Track distance and time.'),
            
            // Chest
            ex('Barbell Bench Press', 'Chest', WEIGHT_REPS.id, 'Lie on flat bench, grip bar wider than shoulders. Lower to chest, press up. Keep feet planted.'),
            ex('Cable Flyes', 'Chest', WEIGHT_REPS.id, 'Stand between cable machines, arms extended. Bring hands together in front of chest. Squeeze pecs.'),
            ex('Chest Press Machine', 'Chest', WEIGHT_REPS.id, 'Sit in machine, grip handles at chest level. Press forward until arms extended. Return with control.'),
            ex('Decline Barbell Bench Press', 'Chest', WEIGHT_REPS.id, 'Lie on decline bench, feet secured. Lower bar to lower chest, press up. Targets lower chest.'),
            ex('Diamond Push-ups', 'Chest', REPS_ONLY.id, 'Push-up position with hands forming diamond. Lower chest to hands. Emphasizes triceps and inner chest.'),
            ex('Dips (Chest)', 'Chest', REPS_ONLY.id, 'Grip parallel bars, lean torso forward. Lower body, then press up. Forward lean targets chest.'),
            ex('Dumbbell Bench Press', 'Chest', WEIGHT_REPS.id, 'Lie on bench with dumbbells at chest. Press up until arms extended. Lower with control. Greater range than barbell.'),
            ex('Dumbbell Flyes', 'Chest', WEIGHT_REPS.id, 'Lie on bench, arms extended with slight bend. Lower dumbbells out to sides. Bring together above chest.'),
            ex('Incline Barbell Bench Press', 'Chest', WEIGHT_REPS.id, 'Lie on 30-45 degree incline bench. Lower bar to upper chest, press up. Targets upper chest.'),
            ex('Incline Dumbbell Press', 'Chest', WEIGHT_REPS.id, 'Lie on incline bench with dumbbells. Press up to extend arms. Lower with control. Upper chest focus.'),
            ex('Pec Deck Machine', 'Chest', WEIGHT_REPS.id, 'Sit with arms on pads or gripping handles. Bring arms together in front. Squeeze chest at peak.'),
            ex('Push-ups', 'Chest', REPS_ONLY.id, 'Start in plank position. Lower chest to ground, press back up. Keep body straight. Classic bodyweight exercise.'),
            ex('Wide Push-ups', 'Chest', REPS_ONLY.id, 'Push-up with hands placed wider than shoulders. Lower chest to ground. Emphasizes outer chest.'),
            
            // Core
            ex('Ab Wheel Rollout', 'Core', REPS_ONLY.id, 'Kneel holding ab wheel. Roll forward extending body, keep core tight. Roll back to start. Advanced core exercise.'),
            ex('Bicycle Crunches', 'Core', REPS_ONLY.id, 'Lie on back, hands behind head. Alternate bringing opposite elbow to knee. Rotate torso, keep moving.'),
            ex('Bird Dog', 'Core', REPS_ONLY.id, 'Start on hands and knees. Extend opposite arm and leg, hold. Return and switch. Focus on stability.'),
            ex('Cable Crunches', 'Core', WEIGHT_REPS.id, 'Kneel at cable machine, hold rope at head. Crunch down bringing elbows to knees. Contract abs fully.'),
            ex('Crunches', 'Core', REPS_ONLY.id, 'Lie on back, knees bent, hands behind head. Lift shoulders off ground, contract abs. Lower with control.'),
            ex('Dead Bug', 'Core', REPS_ONLY.id, 'Lie on back, arms and legs up. Lower opposite arm and leg slowly. Keep lower back pressed to floor.'),
            ex('Hanging Leg Raises', 'Core', REPS_ONLY.id, 'Hang from bar with straight arms. Raise straight legs to parallel or higher. Lower slowly. Advanced.'),
            ex('Leg Raises', 'Core', REPS_ONLY.id, 'Lie on back, legs straight. Raise legs to 90 degrees, lower slowly. Keep lower back pressed down. Lower abs.'),
            ex('Mountain Climbers', 'Core', TIMED.id, 'Plank position, alternate driving knees to chest. Keep core tight, move quickly. Dynamic core work.'),
            ex('Plank', 'Core', TIMED.id, 'Forearms and toes on ground, body straight. Hold position, keep core tight. Don\'t let hips sag or rise.'),
            ex('Russian Twists', 'Core', REPS_ONLY.id, 'Sit with knees bent, lean back slightly. Rotate torso side to side. Can hold weight for challenge. Targets obliques.'),
            ex('Side Plank', 'Core', TIMED.id, 'Lie on side, prop up on forearm. Lift hips, body straight. Hold position. Switch sides. Works obliques.'),
            ex('Sit-ups', 'Core', REPS_ONLY.id, 'Lie on back, knees bent, feet anchored. Sit all the way up, return with control. Full abdominal range.'),
            ex('V-ups', 'Core', REPS_ONLY.id, 'Lie flat on back. Simultaneously raise arms and legs to form V. Touch toes, lower. Advanced core move.'),
            
            // Forearms
            ex('Dead Hang', 'Forearms', TIMED.id, 'Hang from pull-up bar with straight arms. Hold as long as possible. Builds grip strength and forearm endurance.'),
            ex('Farmers Walk', 'Forearms', TIMED.id, 'Hold heavy dumbbells or kettlebells at sides. Walk with good posture. Grip and core strength builder.'),
            ex('Hammer Curl (Forearm)', 'Forearms', WEIGHT_REPS.id, 'Hold dumbbells with neutral grip. Curl up keeping palms facing each other. Targets brachioradialis.'),
            ex('Plate Pinch', 'Forearms', TIMED.id, 'Pinch weight plates between fingers and thumb. Hold at sides. Builds crushing grip strength.'),
            ex('Reverse Curls', 'Forearms', WEIGHT_REPS.id, 'Hold barbell with overhand grip. Curl up keeping palms down. Targets brachioradialis and forearms.'),
            ex('Reverse Wrist Curls', 'Forearms', WEIGHT_REPS.id, 'Rest forearms on bench, palms down. Curl wrists up, lower slowly. Works top of forearms.'),
            ex('Wrist Curls', 'Forearms', WEIGHT_REPS.id, 'Rest forearms on bench, palms up. Curl wrists up, squeeze. Lower slowly. Builds flexor strength.'),
            
            // Full Body
            ex('Battle Ropes', 'Full Body', TIMED.id, 'Hold rope ends, create waves by moving arms up and down. Keep core tight. High intensity full body cardio.'),
            ex('Burpees (Full Body)', 'Full Body', REPS_ONLY.id, 'Drop to plank, push-up, jump feet in, explosive jump up. Full body conditioning movement.'),
            ex('Kettlebell Swings', 'Full Body', REPS_ONLY.id, 'Hinge at hips, swing kettlebell between legs. Drive hips forward, swing to shoulder height. Power from hips.'),
            ex('Man Makers', 'Full Body', REPS_ONLY.id, 'Burpee with dumbbells, add rows at bottom, press overhead at top. Ultimate full body exercise.'),
            ex('Sled Pull', 'Full Body', TIMED.id, 'Attach rope to sled, walk backward pulling sled. Keep core tight, maintain steady pace. Full body strength.'),
            ex('Sled Push', 'Full Body', TIMED.id, 'Push weighted sled with arms extended or low. Drive with legs, keep core engaged. Explosive power builder.'),
            ex('Thrusters', 'Full Body', WEIGHT_REPS.id, 'Hold weight at shoulders, squat down. Stand explosively and press overhead. Full body compound movement.'),
            ex('Turkish Get-Ups', 'Full Body', REPS_ONLY.id, 'Lie holding kettlebell up. Stand up through series of movements. Lower back down. Complex full body exercise.'),
            
            // Functional
            ex('Atlas Stone Lift', 'Functional', REPS_ONLY.id, 'Squat to grip atlas stone. Lift stone to chest, then to platform. Strongman training movement.'),
            ex('Bear Crawl', 'Functional', TIMED.id, 'Crawl on hands and feet with knees off ground. Move forward, backward, or laterally. Full body stability.'),
            ex('Crab Walk', 'Functional', TIMED.id, 'Sit with hands behind, feet in front. Lift hips, walk on hands and feet. Shoulders and core work.'),
            ex('Farmer Carries', 'Functional', TIMED.id, 'Hold heavy weights at sides, walk with upright posture. Core stability and grip strength builder.'),
            ex('Overhead Carries', 'Functional', TIMED.id, 'Hold weight overhead with locked arms. Walk maintaining stability. Shoulder stability and core strength.'),
            ex('Sandbag Carries', 'Functional', TIMED.id, 'Hold sandbag at chest, shoulders, or overhead. Walk maintaining control. Unstable load training.'),
            ex('Waiter Carries', 'Functional', TIMED.id, 'Hold weight overhead with one arm. Walk keeping arm vertical. Switch arms. Shoulder stability work.'),
            
            // Glutes
            ex('Cable Kickbacks', 'Glutes', WEIGHT_REPS.id, 'Attach ankle cuff to cable. Kick leg back, squeeze glute. Keep hips square. Single leg at a time.'),
            ex('Donkey Kicks', 'Glutes', REPS_ONLY.id, 'Start on hands and knees. Kick one leg up and back, knee bent. Squeeze glute at top. Bodyweight isolation.'),
            ex('Fire Hydrants', 'Glutes', REPS_ONLY.id, 'Hands and knees position. Lift leg out to side, knee bent. Works glute medius. Return and repeat.'),
            ex('Frog Pumps', 'Glutes', REPS_ONLY.id, 'Lie on back, soles of feet together. Thrust hips up, squeeze glutes. Lower and repeat. High rep glute work.'),
            ex('Glute Bridge', 'Glutes', WEIGHT_REPS.id, 'Lie on back, feet flat, knees bent. Thrust hips up, squeeze glutes. Can do single or double leg.'),
            ex('Hip Thrusts (Barbell)', 'Glutes', WEIGHT_REPS.id, 'Upper back on bench, barbell on hips. Thrust hips up to parallel. Best glute mass builder.'),
            ex('Single Leg Glute Bridge', 'Glutes', REPS_ONLY.id, 'Lie on back, one leg extended. Thrust hips up on one leg. Squeeze glute. Challenging unilateral work.'),
            ex('Sumo Deadlift', 'Glutes', WEIGHT_REPS.id, 'Wide stance, toes out, grip barbell inside legs. Drive through heels. Emphasizes glutes and inner thighs.'),
            
            // Hamstrings
            ex('Good Mornings', 'Hamstrings', WEIGHT_REPS.id, 'Barbell on shoulders, hinge at hips. Lower torso while keeping back straight. Return to standing. Hamstring and lower back.'),
            ex('Lying Leg Curl', 'Hamstrings', WEIGHT_REPS.id, 'Lie face down on machine. Curl heels to glutes, squeeze hamstrings. Lower with control.'),
            ex('Nordic Curls', 'Hamstrings', REPS_ONLY.id, 'Kneel with ankles anchored. Lower body forward with control, hamstrings resisting. Advanced eccentric exercise.'),
            ex('Romanian Deadlift (RDL)', 'Hamstrings', WEIGHT_REPS.id, 'Hold barbell, slight knee bend. Hinge at hips lowering weight. Feel stretch in hamstrings. Hip hinge pattern.'),
            ex('Seated Leg Curl', 'Hamstrings', WEIGHT_REPS.id, 'Sit in machine, pad on lower calves. Curl heels under seat. Squeeze hamstrings, return slowly.'),
            ex('Stiff Leg Deadlift', 'Hamstrings', WEIGHT_REPS.id, 'Hold barbell, legs nearly straight. Hinge at hips lowering weight. Keep back straight. Maximum hamstring stretch.'),
            ex('Swiss Ball Leg Curl', 'Hamstrings', REPS_ONLY.id, 'Lie on back, heels on ball. Curl ball to glutes, hips lifted. Hamstring and stability work.'),
            
            // Legs
            ex('Barbell Squat', 'Legs', WEIGHT_REPS.id, 'Bar on upper back, feet shoulder width. Squat down, knees track over toes. Drive up through heels. King of exercises.'),
            ex('Bodyweight Squats', 'Legs', REPS_ONLY.id, 'Feet shoulder width, squat down keeping chest up. Drive through heels to stand. Great warm-up or high rep work.'),
            ex('Bulgarian Split Squat', 'Legs', WEIGHT_REPS.id, 'Rear foot elevated on bench, front leg forward. Squat down on front leg. Drive up. Challenging single leg work.'),
            ex('Calf Raises', 'Legs', WEIGHT_REPS.id, 'Stand on edge or platform. Rise onto toes, squeeze calves. Lower heels for full stretch. Standing or seated variations.'),
            ex('Front Squat', 'Legs', WEIGHT_REPS.id, 'Bar rests on front shoulders. Squat down keeping torso upright. Drive up. More quad emphasis than back squat.'),
            ex('Goblet Squat', 'Legs', WEIGHT_REPS.id, 'Hold dumbbell or kettlebell at chest. Squat down, elbows between knees. Drive up. Great for learning squat form.'),
            ex('Hack Squat', 'Legs', WEIGHT_REPS.id, 'Position in hack squat machine. Lower weight, then drive up through heels. Quad-focused machine exercise.'),
            ex('Hip Thrusts', 'Legs', WEIGHT_REPS.id, 'Upper back on bench, weight on hips. Thrust hips to parallel, squeeze glutes. Lower and repeat. Glute builder.'),
            ex('Jump Squats', 'Legs', REPS_ONLY.id, 'Squat down, explode up jumping off ground. Land softly, repeat. Plyometric leg power exercise.'),
            ex('Leg Curl', 'Legs', WEIGHT_REPS.id, 'Lie face down or sit in machine. Curl weight by bending knees. Squeeze hamstrings at top. Lower slowly.'),
            ex('Leg Extension', 'Legs', WEIGHT_REPS.id, 'Sit in machine, extend legs to straighten knees. Squeeze quads at top. Lower with control. Quad isolation.'),
            ex('Leg Press', 'Legs', WEIGHT_REPS.id, 'Sit in machine, feet on platform. Push weight away by extending legs. Lower with control. Great mass builder.'),
            ex('Romanian Deadlift', 'Legs', WEIGHT_REPS.id, 'Hold bar with slight knee bend. Hinge at hips lowering bar. Feel hamstring stretch. Hip hinge movement.'),
            ex('Step-ups', 'Legs', REPS_ONLY.id, 'Step onto elevated platform with one leg. Drive through heel to stand. Step down. Alternate legs. Functional leg exercise.'),
            ex('Walking Lunges', 'Legs', REPS_ONLY.id, 'Lunge forward alternating legs. Keep torso upright, knee behind toes. Can add weight for challenge.'),
            ex('Wall Sit', 'Legs', TIMED.id, 'Lean back against wall, slide down to 90 degrees. Hold position. Isometric quad endurance exercise.'),
            
            // Lower Back
            ex('Back Extensions', 'Lower Back', REPS_ONLY.id, 'Position on back extension bench. Lower torso down, raise back to parallel. Works lower back, glutes, hamstrings.'),
            ex('Good Mornings (Lower Back)', 'Lower Back', WEIGHT_REPS.id, 'Barbell on shoulders, hinge forward at hips. Keep back straight. Return to standing. Lower back and hamstrings.'),
            ex('Hyperextensions (Lower Back)', 'Lower Back', REPS_ONLY.id, 'Position on hyperextension bench. Lower upper body, raise back up. Focus on lower back contraction.'),
            ex('Reverse Hyperextensions', 'Lower Back', REPS_ONLY.id, 'Lie face down on bench, legs hanging. Lift legs up using glutes and lower back. Lower with control.'),
            ex('Superman', 'Lower Back', TIMED.id, 'Lie face down, arms extended forward. Lift arms, chest, and legs off ground. Hold position. Lower back and posterior chain.'),
            
            // Mobility
            ex('Ankle Mobility', 'Mobility', REPS_ONLY.id, 'Perform ankle circles, dorsiflexion stretches, and mobility drills. Improves ankle range of motion for squats.'),
            ex('Cossack Squats', 'Mobility', REPS_ONLY.id, 'Wide stance, shift weight side to side into deep side lunge. Improves hip and groin mobility.'),
            ex('Hip 90/90', 'Mobility', TIMED.id, 'Sit with front and back leg at 90 degrees. Lean forward over front leg. Switch sides. Hip mobility work.'),
            ex('Hip CARs', 'Mobility', REPS_ONLY.id, 'Stand on one leg, move other leg through full circular range. Controlled articular rotations for hip health.'),
            ex('Shoulder CARs', 'Mobility', REPS_ONLY.id, 'Move arm through full circular range slowly with control. Controlled articular rotations for shoulder health.'),
            ex('Thoracic Rotation', 'Mobility', REPS_ONLY.id, 'On hands and knees, rotate upper body opening chest to side. Improves thoracic spine mobility.'),
            
            // Obliques
            ex('Bicycle Crunches (Obliques)', 'Obliques', REPS_ONLY.id, 'Lie on back, alternate bringing opposite elbow to knee. Rotate torso fully. Great for obliques and abs.'),
            ex('Oblique Crunches', 'Obliques', REPS_ONLY.id, 'Lie on side, crunch up laterally. Contract obliques to lift shoulders. Lower with control. Switch sides.'),
            ex('Russian Twists (Obliques)', 'Obliques', REPS_ONLY.id, 'Sit with knees bent, lean back. Rotate torso side to side, touching floor. Can hold weight for intensity.'),
            ex('Side Bends', 'Obliques', WEIGHT_REPS.id, 'Stand holding dumbbell in one hand. Bend sideways, return to upright. Feel stretch in obliques. Switch sides.'),
            ex('Side Plank (Obliques)', 'Obliques', TIMED.id, 'Lie on side, prop on forearm. Lift hips creating straight line. Hold, engaging obliques. Switch sides.'),
            ex('Wood Choppers', 'Obliques', WEIGHT_REPS.id, 'Use cable machine. Rotate diagonally from high to low or low to high. Obliques and core rotation work.'),
            
            // Olympic Lifts
            ex('Clean and Jerk', 'Olympic Lifts', WEIGHT_REPS.id, 'Pull bar from floor to shoulders (clean), then push press overhead (jerk). Full Olympic lift movement.'),
            ex('Clean Pull', 'Olympic Lifts', WEIGHT_REPS.id, 'Pull bar explosively from floor to upper thigh. Don\'t catch it. Builds power for clean. Triple extension.'),
            ex('Hang Clean', 'Olympic Lifts', WEIGHT_REPS.id, 'Start with bar at thighs. Explosive pull and drop under to catch at shoulders. Olympic lift variation.'),
            ex('Power Clean', 'Olympic Lifts', WEIGHT_REPS.id, 'Pull bar from floor explosively, catch at shoulders in partial squat. Power variation of clean.'),
            ex('Power Snatch', 'Olympic Lifts', WEIGHT_REPS.id, 'Pull bar from floor explosively overhead in one motion. Catch in partial squat. Wide grip power snatch.'),
            ex('Push Press', 'Olympic Lifts', WEIGHT_REPS.id, 'Bar at shoulders, dip slightly, drive up using leg power to press overhead. More weight than strict press.'),
            ex('Snatch', 'Olympic Lifts', WEIGHT_REPS.id, 'Pull bar from floor to overhead in one explosive motion. Catch in deep squat. Wide grip Olympic lift.'),
            
            // Other
            ex('Breathing Exercises', 'Other', TIMED.id, 'Practice diaphragmatic breathing, box breathing, or other breathing techniques. Improves relaxation and recovery.'),
            ex('Foam Rolling (Recovery)', 'Other', TIMED.id, 'Roll muscles over foam roller to release tension. Apply pressure to tight spots. Self-myofascial release.'),
            ex('Ice Bath', 'Other', TIMED.id, 'Immerse body in cold water (50-59°F). Reduces inflammation and aids recovery. Start with short duration.'),
            ex('Meditation', 'Other', TIMED.id, 'Sit quietly, focus on breath or guided meditation. Improves mental clarity and reduces stress. Recovery practice.'),
            ex('Sauna', 'Other', TIMED.id, 'Sit in sauna (150-195°F). Promotes relaxation, circulation, and recovery. Stay hydrated. Post-workout recovery.'),
            
            // Pilates
            ex('Hundred', 'Pilates', REPS_ONLY.id, 'Lie on back, lift head and legs. Pump arms up and down 100 times. Classic Pilates core exercise.'),
            ex('Pilates Bridge', 'Pilates', REPS_ONLY.id, 'Lie on back, feet flat. Lift hips articulating spine up. Lower vertebra by vertebra. Control and precision.'),
            ex('Roll Up', 'Pilates', REPS_ONLY.id, 'Lie flat, slowly roll up to sitting one vertebra at a time. Roll back down with control. Core and flexibility.'),
            ex('Single Leg Circle', 'Pilates', REPS_ONLY.id, 'Lie on back, one leg extended up. Draw circles with leg. Keep hips stable. Switch directions and legs.'),
            ex('Swan', 'Pilates', REPS_ONLY.id, 'Lie face down, hands under shoulders. Lift chest keeping hips down. Lower with control. Back extension work.'),
            ex('Teaser', 'Pilates', REPS_ONLY.id, 'Lie on back, lift legs and torso to V position. Hold balance. Lower with control. Advanced core balance.'),
            
            // Plyometrics
            ex('Box Jumps', 'Plyometrics', REPS_ONLY.id, 'Jump explosively onto elevated box. Land softly, step down. Builds explosive leg power and athleticism.'),
            ex('Broad Jumps', 'Plyometrics', REPS_ONLY.id, 'Jump forward as far as possible. Land softly with bent knees. Horizontal power development.'),
            ex('Clap Push-ups', 'Plyometrics', REPS_ONLY.id, 'Push-up with explosive push to clap hands. Land softly. Upper body plyometric power exercise.'),
            ex('Depth Jumps', 'Plyometrics', REPS_ONLY.id, 'Step off box, land and immediately jump up. Reactive strength training. Advanced plyometric.'),
            ex('Lateral Bounds', 'Plyometrics', REPS_ONLY.id, 'Jump side to side on one leg. Land and stabilize before next jump. Lateral power and stability.'),
            ex('Medicine Ball Slams', 'Plyometrics', REPS_ONLY.id, 'Lift medicine ball overhead, slam down explosively. Catch rebound or pick up. Full body power.'),
            ex('Single Leg Hops', 'Plyometrics', REPS_ONLY.id, 'Hop on one leg continuously. Focus on quick ground contact. Builds reactive strength and ankle stability.'),
            ex('Tuck Jumps', 'Plyometrics', REPS_ONLY.id, 'Jump and bring knees to chest. Land softly, repeat immediately. High intensity plyometric exercise.'),
            
            // Quadriceps
            ex('Bulgarian Split Squats', 'Quadriceps', WEIGHT_REPS.id, 'Rear foot elevated on bench. Squat down on front leg until deep. Drive up through heel. Quad dominant.'),
            ex('Cyclist Squats', 'Quadriceps', WEIGHT_REPS.id, 'Heels elevated on plates. Squat with upright torso. Maximum quad activation. Can use light weight for high reps.'),
            ex('Front Squat (Barbell)', 'Quadriceps', WEIGHT_REPS.id, 'Bar rests on front shoulders. Squat keeping torso vertical. Drive up. Quad-focused squat variation.'),
            ex('Leg Extension Machine', 'Quadriceps', WEIGHT_REPS.id, 'Sit in machine. Extend legs to straighten knees fully. Squeeze quads at top. Lower slowly. Quad isolation.'),
            ex('Leg Press (High Foot)', 'Quadriceps', WEIGHT_REPS.id, 'Feet high on platform. Push weight away extending legs. Lower with control. Emphasizes quads over glutes.'),
            ex('Sissy Squats', 'Quadriceps', REPS_ONLY.id, 'Lean back while bending knees, keeping hips extended. Advanced quad isolation. Hold support for balance.'),
            ex('Walking Lunges', 'Quadriceps', WEIGHT_REPS.id, 'Lunge forward alternating legs. Keep front knee over ankle. Drive through heel. Can add dumbbells or barbell.'),
            
            // Shoulders
            ex('Arnold Press', 'Shoulders', WEIGHT_REPS.id, 'Start with palms facing you, press up while rotating palms out. Lower reversing motion. Hits all deltoid heads.'),
            ex('Cable Lateral Raises', 'Shoulders', WEIGHT_REPS.id, 'Stand sideways to cable. Raise arm out to side to shoulder height. Lower slowly. Targets side delts.'),
            ex('Dumbbell Shoulder Press', 'Shoulders', WEIGHT_REPS.id, 'Dumbbells at shoulder height. Press overhead until arms extended. Lower with control. Can do seated or standing.'),
            ex('Front Raises', 'Shoulders', WEIGHT_REPS.id, 'Hold weight at thighs. Raise forward to shoulder height. Lower slowly. Targets anterior deltoids.'),
            ex('Handstand Push-ups', 'Shoulders', REPS_ONLY.id, 'Kick up to handstand against wall. Lower head to ground, press back up. Advanced shoulder and pressing strength.'),
            ex('Lateral Raises', 'Shoulders', WEIGHT_REPS.id, 'Hold dumbbells at sides. Raise out to sides to shoulder height. Lead with elbows. Targets side delts.'),
            ex('Overhead Press (Barbell)', 'Shoulders', WEIGHT_REPS.id, 'Bar at shoulders. Press overhead until arms locked. Lower to shoulders. Standing or seated. Main shoulder builder.'),
            ex('Pike Push-ups', 'Shoulders', REPS_ONLY.id, 'Start in downward dog position. Bend elbows lowering head toward ground. Press back up. Bodyweight shoulder work.'),
            ex('Rear Delt Flyes', 'Shoulders', WEIGHT_REPS.id, 'Bend over at hips. Raise dumbbells out to sides, squeeze shoulder blades. Targets rear deltoids.'),
            ex('Shoulder Press Machine', 'Shoulders', WEIGHT_REPS.id, 'Sit in machine, grip handles at shoulders. Press up until arms extended. Lower with control. Stable pressing.'),
            ex('Upright Rows', 'Shoulders', WEIGHT_REPS.id, 'Hold bar with narrow grip. Pull up along body to chin height. Lower slowly. Works traps and side delts.'),
            
            // Sports
            ex('Basketball', 'Sports', TIMED.id, 'Play basketball for conditioning and skill work. Great for agility, jumping, and cardiovascular fitness.'),
            ex('Boxing', 'Sports', TIMED.id, 'Practice boxing combinations, heavy bag work, or sparring. Full body conditioning and upper body power.'),
            ex('Kickboxing', 'Sports', TIMED.id, 'Practice kicks, punches, and combinations. High intensity full body cardio and martial arts training.'),
            ex('Rock Climbing', 'Sports', TIMED.id, 'Climb indoor or outdoor routes. Builds grip strength, upper body strength, and problem-solving skills.'),
            ex('Soccer', 'Sports', TIMED.id, 'Play soccer for cardiovascular fitness, agility, and lower body conditioning. Great interval training.'),
            ex('Swimming Laps', 'Sports', DISTANCE_TIME.id, 'Swim continuous laps using various strokes. Low impact full body cardio and muscular endurance.'),
            ex('Tennis', 'Sports', TIMED.id, 'Play tennis for agility, lateral movement, and cardiovascular fitness. Builds court awareness and reactions.'),
            
            // Stretching
            ex('Cat-Cow Stretch', 'Stretching', TIMED.id, 'On hands and knees, alternate arching and rounding spine. Improves spinal mobility and relieves back tension.'),
            ex('Chest Stretch', 'Stretching', TIMED.id, 'Stand in doorway, arm against frame. Turn body away to stretch chest and front shoulder. Hold each side.'),
            ex('Hamstring Stretch', 'Stretching', TIMED.id, 'Sit with one leg extended, reach toward toes. Keep back straight. Feel stretch in back of thigh. Hold each leg.'),
            ex('Hip Flexor Stretch', 'Stretching', TIMED.id, 'Lunge position with back knee down. Push hips forward to stretch front of hip. Hold each side. Relieves hip tightness.'),
            ex('Pigeon Pose', 'Stretching', TIMED.id, 'Front leg bent, back leg extended. Fold forward over front leg. Deep hip and glute stretch. Hold each side.'),
            ex('Quad Stretch', 'Stretching', TIMED.id, 'Stand on one leg, pull other foot to glutes. Keep knees together. Stretch front of thigh. Hold each leg.'),
            ex('Shoulder Stretch', 'Stretching', TIMED.id, 'Pull one arm across body with other arm. Feel stretch in shoulder and upper back. Hold each side.'),
            ex('Tricep Stretch', 'Stretching', TIMED.id, 'Reach one arm overhead, bend elbow behind head. Pull elbow with other hand. Stretch back of arm. Hold each side.'),
            
            // Traps
            ex('Barbell Shrugs', 'Traps', WEIGHT_REPS.id, 'Hold barbell at arms length. Shrug shoulders straight up toward ears. Squeeze traps at top. Lower slowly.'),
            ex('Cable Shrugs', 'Traps', WEIGHT_REPS.id, 'Hold cable attachment at arms length. Shrug shoulders up, squeeze traps. Lower with control. Constant tension variation.'),
            ex('Dumbbell Shrugs', 'Traps', WEIGHT_REPS.id, 'Hold dumbbells at sides. Shrug shoulders straight up. Squeeze at top. Lower slowly. Classic trap builder.'),
            ex('Face Pulls (Trap Focus)', 'Traps', WEIGHT_REPS.id, 'Pull rope toward face, separate hands. Focus on upper back and trap contraction. Shoulder health exercise.'),
            ex('Overhead Shrugs', 'Traps', WEIGHT_REPS.id, 'Hold weight overhead with locked arms. Shrug shoulders up, pressing weight higher. Advanced trap variation.'),
            ex('Rack Pulls', 'Traps', WEIGHT_REPS.id, 'Partial deadlift from pins at knee height. Pull weight up using traps and upper back. Heavy trap and back builder.'),
            
            // Triceps
            ex('Bench Dips', 'Triceps', REPS_ONLY.id, 'Hands on bench behind, feet forward or elevated. Lower body by bending elbows. Press back up. Bodyweight tricep work.'),
            ex('Close Grip Bench Press', 'Triceps', WEIGHT_REPS.id, 'Lie on bench, grip bar narrower than shoulders. Lower to chest, press up. Emphasizes triceps over chest.'),
            ex('Diamond Push-ups', 'Triceps', REPS_ONLY.id, 'Push-up with hands forming diamond shape. Lower chest to hands. Press up. Intense tricep activation.'),
            ex('Dips (Tricep)', 'Triceps', REPS_ONLY.id, 'Grip parallel bars, keep body upright. Lower by bending elbows. Press back up. Great bodyweight tricep builder.'),
            ex('Kickbacks', 'Triceps', WEIGHT_REPS.id, 'Bent over, upper arm parallel to ground. Extend forearm back until arm straight. Squeeze tricep. Return slowly.'),
            ex('Overhead Tricep Extension', 'Triceps', WEIGHT_REPS.id, 'Hold weight overhead. Lower behind head by bending elbows. Extend arms back up. Can use dumbbell or cable.'),
            ex('Skull Crushers', 'Triceps', WEIGHT_REPS.id, 'Lie on bench, arms extended. Lower weight to forehead by bending elbows. Extend back up. Also called lying tricep extension.'),
            ex('Tricep Pushdown (Cable)', 'Triceps', WEIGHT_REPS.id, 'Stand at cable machine. Push attachment down until arms straight. Return slowly. Can use rope, bar, or V-bar.'),
            
            // Yoga
            ex('Bridge Pose (Yoga)', 'Yoga', TIMED.id, 'Lie on back, feet flat. Lift hips high, pressing through feet. Clasp hands under back. Opens chest and strengthens back.'),
            ex('Child Pose', 'Yoga', TIMED.id, 'Sit back on heels, extend arms forward. Rest forehead on ground. Relaxing stretch for back, shoulders, and hips.'),
            ex('Cobra Pose', 'Yoga', TIMED.id, 'Lie face down, hands under shoulders. Press up lifting chest, keeping hips down. Back extension and chest opener.'),
            ex('Downward Dog', 'Yoga', TIMED.id, 'Inverted V position, hands and feet on ground. Push hips up and back. Full body stretch, especially hamstrings and shoulders.'),
            ex('Sun Salutation', 'Yoga', REPS_ONLY.id, 'Flow through sequence of poses: mountain, forward fold, plank, cobra, downward dog, and back. Classic yoga warm-up.'),
            ex('Tree Pose', 'Yoga', TIMED.id, 'Stand on one leg, other foot on inner thigh. Hands in prayer or overhead. Balance pose for focus and stability.'),
            ex('Warrior Pose', 'Yoga', TIMED.id, 'Lunge position with arms extended. Front knee bent, back leg straight. Strong standing pose for legs and balance.')
          ];
          const initialState = JSON.parse(JSON.stringify(this._defaults));
          initialState.exercises = defaultExercises;
          initialState._nextId = nextId;
          return initialState;
        },

        _migrateExercises(exercises) {
          console.log('Migrating old exercise data to new format...');
          return exercises.map(ex => ({ ...ex, type: ex.category === 'Cardio' ? this._constants.EXERCISE_TYPES.DISTANCE_TIME.id : this._constants.EXERCISE_TYPES.WEIGHT_REPS.id, notes: ex.notes || '' }));
        },
        get() { return this._data; }, getConstants() { return this._constants; },
        generateId(prefix) { return `${prefix}-${this._data._nextId++}`; }, addExercise(exercise) { this._data.exercises.push(exercise); },
        updateExercise(id, updates) {
          const ex = this._data.exercises.find(ex => ex.id === id);
          if (ex) {
            Object.assign(ex, updates);
          }
        },
        deleteExercise(id) {
          this._data.exercises = this._data.exercises.filter(ex => ex.id !== id);
          this._data.history = this._data.history.filter(h => h.exerciseId !== id);
        },
        addHistoryItem(item) { this._data.history.push(item); }, setActiveTab(tabId) { this._data.activeTab = tabId; },
        setLogFormField(field, value) { this._data.logForm[field] = value; },
        resetLogForm() { this._data.logForm = { ...this._defaults.logForm, exerciseId: this._data.logForm.exerciseId }; },
        setFilter(query) { this._data.settings.filter = query; },
        setEditingExercise(id, category) {
          this._data.settings.editingExerciseId = id;
          this._data.settings.editingCategory = category;
        },
        setKeepCategoryOpen(category) { this._data.settings.keepCategoryOpen = category; },
        setRestTimer(data) { Object.assign(this._data.restTimer, data); },
        getRestTimer() { return this._data.restTimer; }
      };

      // ===================================================================================
      // DOM MODULE
      // ===================================================================================
      const DOM = {
        init() {
          const get = (id) => document.getElementById(id);
          this.announcer = get('announcer');
          this.tabs = document.querySelector('.tabs__list');
          this.logForm = get('log-form');
          this.logExerciseSelect = get('log-exercise');
          this.logGroups = { weight: get('log-weight-group'), reps: get('log-reps-group'), distance: get('log-distance-group'), duration: get('log-duration-group') };
          this.logInputs = { weight: get('log-weight'), reps: get('log-reps'), distance: get('log-distance'), duration: get('log-duration') };
          this.logDurationLabel = this.logGroups.duration.querySelector('label');
          this.historyContainer = get('history-container');
          this.historyList = get('history-list');
          this.historyTitle = get('history-title');
          this.historyEmptyState = get('history-empty-state');
          this.addExerciseForm = get('add-exercise-form');
          this.newExerciseInputs = { name: get('new-exercise-name'), category: get('new-exercise-category'), type: get('new-exercise-type'), notes: get('new-exercise-notes') };
          this.manageExerciseList = get('manage-exercise-list');
          this.manageExerciseEmptyState = get('manage-exercise-empty-state');
          this.dialog = get('confirmation-dialog');
          this.dialogTitle = get('dialog-title');
          this.dialogMessage = get('dialog-message');
          this.dialogConfirmBtn = get('dialog-confirm-btn');
          this.dialogCancelBtn = get('dialog-cancel-btn');
          this.restTimer = get('rest-timer');
          this.restTimerToggle = get('rest-timer-toggle');
          this.restTimerToggleDisplay = get('rest-timer-toggle-display');
          this.restTimerDisplay = get('rest-timer-display');
          this.restTimerDecrease = get('rest-timer-decrease');
          this.restTimerIncrease = get('rest-timer-increase');
          this.restTimerPause = get('rest-timer-pause');
          this.restTimerReset = get('rest-timer-reset');
          this.manageExercisesMenuToggle = get('manage-exercises-menu-toggle');
          this.manageExercisesMenu = get('manage-exercises-menu');
          this.resetExercisesBtn = get('reset-exercises-btn');
        }
      };

      // ===================================================================================
      // UI MODULE
      // ===================================================================================
      const UI = {
        render() {
          DOM.historyContainer.setAttribute('aria-busy', 'true');
          this.renderTabs();
          this.renderLogForm();
          this.renderHistory();
          this.renderManageExerciseList();
          DOM.historyContainer.setAttribute('aria-busy', 'false');
        },
        renderTabs() {
          const { activeTab } = State.get();
          document.querySelectorAll('[role="tab"]').forEach(tab => {
            const isSelected = tab.id === `${activeTab}-tab`;
            tab.setAttribute('aria-selected', isSelected);
            const panel = document.getElementById(tab.getAttribute('aria-controls'));
            if (panel) {
              panel.hidden = !isSelected;
            }
          });
        },
        updateLogFormVisibility() {
          const { exercises, logForm } = State.get();
          const selectedExercise = exercises.find(ex => ex.id === logForm.exerciseId);
          Object.values(DOM.logGroups).forEach(g => g.hidden = true);
          Object.values(DOM.logInputs).forEach(i => i.required = false);
          DOM.logForm.className = 'form form--log';
          if (!selectedExercise) {
            return;
          }
          const { EXERCISE_TYPES } = State.getConstants();
          let visibleGroups = 0;
          switch (selectedExercise.type) {
            case EXERCISE_TYPES.WEIGHT_REPS.id:
              DOM.logGroups.weight.hidden = false;
              DOM.logInputs.weight.required = true;
              DOM.logGroups.reps.hidden = false;
              DOM.logInputs.reps.required = true;
              visibleGroups = 2;
              break;
            case EXERCISE_TYPES.REPS_ONLY.id:
              DOM.logGroups.reps.hidden = false;
              DOM.logInputs.reps.required = true;
              visibleGroups = 1;
              break;
            case EXERCISE_TYPES.TIMED.id:
              DOM.logGroups.duration.hidden = false;
              DOM.logInputs.duration.required = true;
              DOM.logDurationLabel.textContent = 'Duration (seconds)';
              DOM.logInputs.duration.placeholder = '60';
              visibleGroups = 1;
              break;
            case EXERCISE_TYPES.DISTANCE_TIME.id:
              DOM.logGroups.distance.hidden = false;
              DOM.logInputs.distance.required = true;
              DOM.logGroups.duration.hidden = false;
              DOM.logInputs.duration.required = true;
              DOM.logDurationLabel.textContent = 'Time (minutes)';
              DOM.logInputs.duration.placeholder = '30';
              visibleGroups = 2;
              break;
          }
          if (visibleGroups === 2) {
            DOM.logForm.classList.add('grid-cols-3');
          } else if (visibleGroups === 1) {
            DOM.logForm.classList.add('grid-cols-2');
          }
        },
        renderLogForm() {
          const { exercises, logForm } = State.get();
          DOM.logExerciseSelect.innerHTML = '<option value="">Select an exercise...</option>';
          const exercisesByCategory = exercises.reduce((acc, ex) => {
            (acc[ex.category] = acc[ex.category] || []).push(ex);
            return acc;
          }, {});
          Object.keys(exercisesByCategory).sort().forEach(category => {
            const optgroup = document.createElement('optgroup');
            optgroup.label = category;
            exercisesByCategory[category].sort((a, b) => a.name.localeCompare(b.name)).forEach(ex => {
              const option = document.createElement('option');
              option.value = ex.id;
              option.textContent = ex.name;
              optgroup.appendChild(option);
            });
            DOM.logExerciseSelect.appendChild(optgroup);
          });
          DOM.logExerciseSelect.value = logForm.exerciseId;
          Object.entries(logForm).forEach(([key, value]) => {
            if (DOM.logInputs[key]) {
              DOM.logInputs[key].value = value;
            }
          });
          this.updateLogFormVisibility();
        },
        renderHistory() {
          const { exercises, history, logForm } = State.get();
          const filterExerciseId = logForm.exerciseId;
          let historyToRender = history;
          if (filterExerciseId) {
            const filteredExercise = exercises.find(ex => ex.id === filterExerciseId);
            DOM.historyTitle.textContent = `History for ${filteredExercise?.name || 'Unknown'}`;
            historyToRender = history.filter(item => item.exerciseId === filterExerciseId);
          } else {
            DOM.historyTitle.textContent = 'History';
          }

          DOM.historyList.innerHTML = '';
          const sortedHistory = [...historyToRender].sort((a, b) => b.timestamp - a.timestamp);
          DOM.historyEmptyState.hidden = sortedHistory.length > 0;
          DOM.historyList.hidden = sortedHistory.length === 0;
          if (sortedHistory.length === 0) {
            DOM.historyEmptyState.textContent = filterExerciseId ? 'No activities logged for this exercise yet.' : 'No activities logged yet. Let\'s get to work!';
            return;
          }
          const activitiesByDate = sortedHistory.reduce((acc, activity) => {
            const date = new Date(activity.timestamp).toLocaleDateString('en-CA');
            (acc[date] = acc[date] || []).push(activity);
            return acc;
          }, {});
          Object.keys(activitiesByDate).sort((a, b) => new Date(b) - new Date(a)).forEach((dateString, index) => {
            const activities = activitiesByDate[dateString];
            const details = document.createElement('details');
            if (index === 0) {
              details.open = true;
            }
            const summary = document.createElement('summary');
            summary.className = 'collapsible-group__summary';
            summary.textContent = `${new Date(dateString).toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' })} (${activities.length} activit${activities.length > 1 ? 'ies' : 'y'})`;
            const innerList = document.createElement('ul');
            innerList.className = 'collapsible-group__list';
            activities.forEach(item => {
              const exercise = exercises.find(ex => ex.id === item.exerciseId);
              if (!exercise) {
                return;
              }
              let metaText = '';
              if (item.hasOwnProperty('weight')) {
                metaText = `${item.weight || 0} kg × ${item.reps} reps`;
              } else if (item.hasOwnProperty('distance')) {
                metaText = `${item.distance} km in ${item.duration} min`;
              } else if (item.hasOwnProperty('reps')) {
                metaText = `${item.reps} reps`;
              } else if (item.hasOwnProperty('duration')) {
                metaText = `${item.duration} seconds`;
              }
              const li = document.createElement('li');
              li.className = 'history-list__item';
              li.innerHTML = `<div class="history-list__details"><span class="history-list__exercise">${exercise.name}</span><span class="history-list__meta">${metaText}</span></div><span class="history-list__time">${new Date(item.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>`;
              innerList.appendChild(li);
            });
            details.append(summary, innerList);
            DOM.historyList.appendChild(details);
          });
        },
        renderManageExerciseList() {
          const { exercises, settings } = State.get();
          const { EXERCISE_CATEGORIES, EXERCISE_TYPES } = State.getConstants();
          const createOptions = (items) => items.map(item => `<option value="${item.value}">${item.label}</option>`).join('');
          DOM.newExerciseInputs.category.innerHTML = createOptions(EXERCISE_CATEGORIES.map(c => ({ value: c, label: c })));
          DOM.newExerciseInputs.type.innerHTML = createOptions(Object.values(EXERCISE_TYPES).map(t => ({ value: t.id, label: t.label })));
          DOM.manageExerciseList.innerHTML = '';
          const filterQuery = settings.filter.trim().toLowerCase();
          const filteredExercises = exercises.filter(ex => ex.name.toLowerCase().includes(filterQuery));
          DOM.manageExerciseEmptyState.hidden = filteredExercises.length > 0;
          DOM.manageExerciseList.hidden = filteredExercises.length === 0;
          if (filteredExercises.length > 0) {
            const exercisesByCategory = filteredExercises.reduce((acc, ex) => {
              (acc[ex.category] = acc[ex.category] || []).push(ex);
              return acc;
            }, {});
            Object.keys(exercisesByCategory).sort().forEach(category => {
              const details = document.createElement('details');
              if (filterQuery || settings.editingCategory === category || settings.keepCategoryOpen === category) { details.open = true; }
              const summary = document.createElement('summary');
              summary.className = 'collapsible-group__summary';
              summary.textContent = `${category} (${exercisesByCategory[category].length} exercise${exercisesByCategory[category].length > 1 ? 's' : ''})`;
              const list = document.createElement('ul');
              list.className = 'collapsible-group__list';
              exercisesByCategory[category].sort((a, b) => a.name.localeCompare(b.name)).forEach(ex => list.appendChild(this._createExerciseListItem(ex)));
              details.append(summary, list);
              DOM.manageExerciseList.appendChild(details);
            });
          }
        },
        _createExerciseListItem(exercise) {
          const { editingExerciseId } = State.get().settings;
          const li = document.createElement('li');
          li.className = 'exercise-list__item';
          if (editingExerciseId === exercise.id) {
            li.style.padding = '1rem';
            li.appendChild(this._createExerciseEditView(exercise));
          } else { li.appendChild(this._createExerciseDisplayView(exercise)); }
          return li;
        },
        _createExerciseDisplayView(exercise) {
          const fragment = document.createDocumentFragment();
          const mainDiv = document.createElement('div');
          mainDiv.className = 'exercise-list__item-main';
          const nameSpan = document.createElement('span');
          nameSpan.className = 'exercise-list__name';
          nameSpan.textContent = exercise.name;
          mainDiv.appendChild(nameSpan);
          const actionsDiv = document.createElement('div');
          actionsDiv.className = 'exercise-list__actions';
          const editButton = this._createIconButton({ action: 'edit', exerciseId: exercise.id, label: `Edit ${exercise.name}`, svgPath: 'M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zM1.586 11.5 3.207 10 9.707 3.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l-6.5 6.5zm-1.25 2.5.106-.106 3.821-1.528-1.528 3.821-.106.106a.5.5 0 0 1-.468-.325z' });
          const deleteButton = this._createIconButton({ action: 'delete', exerciseId: exercise.id, label: `Delete ${exercise.name}`, extraClass: 'button--danger-hover', svgPath: 'M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0zM14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3V2h11v1z' });
          actionsDiv.append(editButton, deleteButton);
          fragment.append(mainDiv, actionsDiv);
          return fragment;
        },
        _createExerciseEditView(exercise) {
          const { EXERCISE_CATEGORIES, EXERCISE_TYPES } = State.getConstants();
          const createSelect = (id, options, selectedValue) => {
            const select = document.createElement('select');
            select.className = 'input';
            select.id = id;
            options.forEach(opt => {
              const option = document.createElement('option');
              option.value = opt.value;
              option.textContent = opt.label;
              if (opt.value === selectedValue) {
                option.selected = true;
              }
              select.appendChild(option);
            });
            return select;
          };
          
          const createFormGroup = (labelText, inputElement) => {
            const group = document.createElement('div');
            group.className = 'form-group';
            const label = document.createElement('label');
            label.className = 'form-group__label';
            label.textContent = labelText;
            label.setAttribute('for', inputElement.id);
            group.append(label, inputElement);
            return group;
          };
          
          const fieldsDiv = document.createElement('div');
          fieldsDiv.className = 'exercise-list__edit-fields';
          
          const nameInput = document.createElement('input');
          nameInput.type = 'text';
          nameInput.className = 'input';
          nameInput.required = true;
          nameInput.id = `edit-exercise-name-${exercise.id}`;
          nameInput.value = exercise.name;
          
          const categorySelect = createSelect(`edit-exercise-category-${exercise.id}`, EXERCISE_CATEGORIES.map(c => ({ value: c, label: c })), exercise.category);
          const typeSelect = createSelect(`edit-exercise-type-${exercise.id}`, Object.values(EXERCISE_TYPES).map(t => ({ value: t.id, label: t.label })), exercise.type);
          
          const notesTextarea = document.createElement('textarea');
          notesTextarea.className = 'input';
          notesTextarea.placeholder = 'Notes...';
          notesTextarea.id = `edit-exercise-notes-${exercise.id}`;
          notesTextarea.textContent = exercise.notes || '';
          
          const actionsDiv = document.createElement('div');
          actionsDiv.className = 'exercise-list__actions';
          actionsDiv.style.justifyContent = 'flex-end';
          actionsDiv.style.marginTop = '0.5rem';
          const cancelButton = this._createTextButton({ text: 'Cancel', action: 'cancel', exerciseId: exercise.id, classList: ['button--secondary'] });
          const saveButton = this._createTextButton({ text: 'Save', action: 'save', exerciseId: exercise.id, classList: ['button--primary'] });
          actionsDiv.append(cancelButton, saveButton);
          
          fieldsDiv.append(
            createFormGroup('Exercise Name', nameInput),
            createFormGroup('Category', categorySelect),
            createFormGroup('Exercise Type', typeSelect),
            createFormGroup('Notes (Optional)', notesTextarea),
            actionsDiv
          );
          
          return fieldsDiv;
        },
        _createIconButton({ action, exerciseId, label, svgPath, extraClass = '' }) {
          const button = document.createElement('button');
          button.className = `button button--icon ${extraClass}`;
          button.type = 'button';
          button.dataset.action = action;
          button.dataset.exerciseId = exerciseId;
          button.setAttribute('aria-label', label);
          button.innerHTML = `<svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="${svgPath}"/></svg>`;
          return button;
        },
        _createTextButton({ text, action, exerciseId, classList = [] }) {
          const button = document.createElement('button');
          button.className = `button ${classList.join(' ')}`;
          button.type = 'button';
          button.textContent = text;
          button.dataset.action = action;
          button.dataset.exerciseId = exerciseId;
          return button;
        },
        showDialog({ title, message, confirmText = 'Confirm', showCancel = true }) {
          DOM.dialogTitle.textContent = title;
          DOM.dialogMessage.textContent = message;
          DOM.dialogConfirmBtn.textContent = confirmText;
          DOM.dialogCancelBtn.hidden = !showCancel;
          DOM.dialog.showModal();
          return new Promise(resolve => {
            const cleanup = (result) => {
              DOM.dialogConfirmBtn.removeEventListener('click', confirmHandler);
              DOM.dialogCancelBtn.removeEventListener('click', cancelHandler);
              DOM.dialog.close();
              resolve(result);
            };
            const confirmHandler = () => cleanup(true);
            const cancelHandler = () => cleanup(false);
            DOM.dialogConfirmBtn.addEventListener('click', confirmHandler, { once: true });
            DOM.dialogCancelBtn.addEventListener('click', cancelHandler, { once: true });
          });
        },
        announce(message) { DOM.announcer.textContent = message; }
      };

      // ===================================================================================
      // EVENTS MODULE
      // ===================================================================================
      const Events = {
        restTimerInterval: null,
        
        init() {
          DOM.tabs.addEventListener('click', this.handleTabClick.bind(this));
          DOM.logForm.addEventListener('submit', this.handleLogFormSubmit.bind(this));
          DOM.logForm.addEventListener('input', this.handleLogFormInput.bind(this));
          DOM.restTimerToggle.addEventListener('click', this.handleRestTimerToggle.bind(this));
          DOM.restTimerDecrease.addEventListener('click', this.handleRestTimerDecrease.bind(this));
          DOM.restTimerIncrease.addEventListener('click', this.handleRestTimerIncrease.bind(this));
          DOM.restTimerPause.addEventListener('click', this.handleRestTimerPause.bind(this));
          DOM.restTimerReset.addEventListener('click', this.handleRestTimerReset.bind(this));
          DOM.addExerciseForm.addEventListener('submit', this.handleAddExerciseFormSubmit.bind(this));
          DOM.manageExerciseList.addEventListener('click', this.handleManageListClick.bind(this));
          DOM.newExerciseInputs.name.addEventListener('input', this.handleSettingsFilterInput.bind(this));
          DOM.manageExercisesMenuToggle.addEventListener('click', this.handleMenuToggle.bind(this));
          DOM.resetExercisesBtn.addEventListener('click', this.handleResetExercises.bind(this));
          document.addEventListener('click', this.handleOutsideClick.bind(this));
          this.updateRestTimerDisplay();
          this.restoreRestTimerState();
          this.resumeRestTimerIfRunning();
        },
        restoreRestTimerState() {
          const timer = State.getRestTimer();
          // Restore expanded/collapsed state
          if (timer.expanded) {
            DOM.restTimer.classList.remove('collapsed');
            DOM.restTimer.classList.add('expanded');
            DOM.restTimerToggle.setAttribute('aria-expanded', 'true');
          } else {
            DOM.restTimer.classList.remove('expanded');
            DOM.restTimer.classList.add('collapsed');
            DOM.restTimerToggle.setAttribute('aria-expanded', 'false');
          }
        },
        resumeRestTimerIfRunning() {
          const timer = State.getRestTimer();
          if (timer.running && !timer.paused) {
            // Calculate how much time has passed since the timer was running
            const elapsed = Math.floor((Date.now() - timer.startTime) / 1000);
            const remaining = Math.max(0, timer.remaining - elapsed);
            
            if (remaining > 0) {
              // Timer is still running, resume it
              State.setRestTimer({
                startTime: Date.now(),
                remaining: remaining
              });
              DOM.restTimerPause.textContent = 'Pause';
              this.startRestTimerInterval();
            } else {
              // Timer expired while page was closed
              this.handleRestTimerComplete();
            }
          } else if (timer.paused) {
            DOM.restTimerPause.textContent = 'Resume';
          }
          this.updateRestTimerDisplay();
        },
        handleRestTimerToggle() {
          const timer = State.getRestTimer();
          const isExpanded = DOM.restTimer.classList.contains('expanded');
          if (isExpanded) {
            DOM.restTimer.classList.remove('expanded');
            DOM.restTimer.classList.add('collapsed');
            DOM.restTimerToggle.setAttribute('aria-expanded', 'false');
            State.setRestTimer({ expanded: false });
          } else {
            DOM.restTimer.classList.remove('collapsed');
            DOM.restTimer.classList.add('expanded');
            DOM.restTimerToggle.setAttribute('aria-expanded', 'true');
            State.setRestTimer({ expanded: true });
          }
          State.save();
        },
        handleRestTimerDecrease() {
          const timer = State.getRestTimer();
          
          if (timer.running && !timer.paused) {
            // Timer is running - subtract 10 seconds from remaining time
            const elapsed = Math.floor((Date.now() - timer.startTime) / 1000);
            const currentRemaining = Math.max(0, timer.remaining - elapsed);
            const newRemaining = Math.max(0, currentRemaining - 10);
            
            State.setRestTimer({ 
              startTime: Date.now(),
              remaining: newRemaining
            });
            State.save();
            this.updateRestTimerDisplay();
            UI.announce(`10 seconds removed`);
          } else {
            // Timer not running - change duration
            const newDuration = Math.max(10, timer.duration - 10);
            State.setRestTimer({ 
              duration: newDuration,
              remaining: newDuration
            });
            State.save();
            this.updateRestTimerDisplay();
            UI.announce(`Rest duration set to ${newDuration} seconds`);
          }
        },
        handleRestTimerIncrease() {
          const timer = State.getRestTimer();
          
          if (timer.running && !timer.paused) {
            // Timer is running - add 10 seconds to remaining time
            const elapsed = Math.floor((Date.now() - timer.startTime) / 1000);
            const currentRemaining = Math.max(0, timer.remaining - elapsed);
            const newRemaining = Math.min(600, currentRemaining + 10);
            
            State.setRestTimer({ 
              startTime: Date.now(),
              remaining: newRemaining
            });
            State.save();
            this.updateRestTimerDisplay();
            UI.announce(`10 seconds added`);
          } else {
            // Timer not running - change duration
            const newDuration = Math.min(600, timer.duration + 10);
            State.setRestTimer({ 
              duration: newDuration,
              remaining: newDuration
            });
            State.save();
            this.updateRestTimerDisplay();
            UI.announce(`Rest duration set to ${newDuration} seconds`);
          }
        },
        handleRestTimerPause() {
          const timer = State.getRestTimer();
          if (!timer.running) {
            // Start timer
            const startingRemaining = timer.remaining || timer.duration;
            State.setRestTimer({
              running: true,
              paused: false,
              startTime: Date.now(),
              remaining: startingRemaining
            });
            DOM.restTimerPause.textContent = 'Pause';
            State.save();
            this.startRestTimerInterval();
            UI.announce('Timer started');
          } else if (timer.paused) {
            // Resume
            State.setRestTimer({
              paused: false,
              startTime: Date.now()
            });
            DOM.restTimerPause.textContent = 'Pause';
            State.save();
            this.startRestTimerInterval();
            UI.announce('Timer resumed');
          } else {
            // Pause
            const elapsed = Math.floor((Date.now() - timer.startTime) / 1000);
            const remaining = Math.max(0, timer.remaining - elapsed);
            State.setRestTimer({
              paused: true,
              remaining: remaining
            });
            DOM.restTimerPause.textContent = 'Resume';
            State.save();
            if (this.restTimerInterval) {
              clearInterval(this.restTimerInterval);
            }
            this.updateRestTimerDisplay();
            UI.announce('Timer paused');
          }
        },
        handleRestTimerReset() {
          const timer = State.getRestTimer();
          State.setRestTimer({
            running: false,
            paused: false,
            remaining: timer.duration
          });
          DOM.restTimerPause.textContent = 'Start';
          DOM.restTimerDisplay.classList.remove('warning', 'complete');
          if (this.restTimerInterval) {
            clearInterval(this.restTimerInterval);
          }
          this.updateRestTimerDisplay();
          State.save();
          UI.announce('Timer reset');
        },
        startRestTimerInterval() {
          if (this.restTimerInterval) {
            clearInterval(this.restTimerInterval);
          }
          // Update immediately
          this.updateRestTimerDisplay();
          // Then update every 100ms for smooth countdown
          this.restTimerInterval = setInterval(() => {
            this.updateRestTimerDisplay();
          }, 100);
        },
        updateRestTimerDisplay() {
          const timer = State.getRestTimer();
          
          let remainingSeconds;
          if (!timer.running) {
            // Show the set duration when not running
            remainingSeconds = timer.remaining || timer.duration;
          } else if (timer.paused) {
            // Show paused remaining time
            remainingSeconds = timer.remaining;
          } else {
            // Calculate countdown - actively running
            const elapsed = Math.floor((Date.now() - timer.startTime) / 1000);
            remainingSeconds = Math.max(0, timer.remaining - elapsed);
            
            // Check if timer is complete
            if (remainingSeconds <= 0) {
              this.handleRestTimerComplete();
              return;
            }
          }
          
          const minutes = Math.floor(remainingSeconds / 60);
          const seconds = remainingSeconds % 60;
          const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
          
          DOM.restTimerDisplay.textContent = timeString;
          DOM.restTimerToggleDisplay.textContent = timeString;
          
          // Visual feedback
          DOM.restTimerDisplay.classList.remove('warning', 'complete');
          if (timer.running && !timer.paused) {
            if (remainingSeconds === 0) {
              DOM.restTimerDisplay.classList.add('complete');
            } else if (remainingSeconds <= 10) {
              DOM.restTimerDisplay.classList.add('warning');
            }
          }
        },
        handleRestTimerComplete() {
          State.setRestTimer({
            running: false,
            paused: false,
            remaining: 0
          });
          DOM.restTimerPause.textContent = 'Start';
          DOM.restTimerDisplay.classList.add('complete');
          if (this.restTimerInterval) {
            clearInterval(this.restTimerInterval);
          }
          this.updateRestTimerDisplay();
          UI.announce('Rest time complete!');
          
          // Visual/audio feedback
          if ('vibrate' in navigator) {
            navigator.vibrate([200, 100, 200]);
          }
          
          // Auto-reset after 2 seconds
          setTimeout(() => {
            const timer = State.getRestTimer();
            if (!timer.running) {
              this.handleRestTimerReset();
            }
          }, 2000);
        },
        handleTabClick(event) {
          if (event.target.closest('[role="tab"]')) {
            State.setActiveTab(event.target.closest('[role="tab"]').id.replace('-tab', ''));
            State.save();
            UI.renderTabs();
          }
        },
        handleLogFormInput(event) {
          const { name, value, id } = event.target;
          State.setLogFormField(name, value);
          if (id === 'log-exercise') {
            State.save();
            UI.updateLogFormVisibility();
            UI.renderHistory();
          }
        },
        handleLogFormSubmit(event) {
          event.preventDefault();
          if (!DOM.logForm.checkValidity()) {
            DOM.logForm.reportValidity();
            return;
          }
          const { exercises, logForm } = State.get();
          const { EXERCISE_TYPES } = State.getConstants();
          const exercise = exercises.find(ex => ex.id === logForm.exerciseId);
          const newActivity = { id: State.generateId('act'), exerciseId: exercise.id, timestamp: Date.now() };
          switch (exercise.type) {
            case EXERCISE_TYPES.WEIGHT_REPS.id:
              newActivity.weight = parseFloat(DOM.logInputs.weight.value || 0);
              newActivity.reps = parseInt(DOM.logInputs.reps.value, 10);
              break;
            case EXERCISE_TYPES.REPS_ONLY.id:
              newActivity.reps = parseInt(DOM.logInputs.reps.value, 10);
              break;
            case EXERCISE_TYPES.TIMED.id:
              newActivity.duration = parseInt(DOM.logInputs.duration.value, 10);
              break;
            case EXERCISE_TYPES.DISTANCE_TIME.id:
              newActivity.distance = parseFloat(DOM.logInputs.distance.value, 10);
              newActivity.duration = parseInt(DOM.logInputs.duration.value, 10);
              break;
          }
          State.addHistoryItem(newActivity);
          State.resetLogForm();
          State.save();
          UI.render();
          UI.announce(`${exercise.name} logged successfully.`);
          DOM.logForm.querySelector('input:not([type=hidden])')?.focus();
        },
        handleAddExerciseFormSubmit(event) {
          event.preventDefault();
          if (!DOM.addExerciseForm.checkValidity()) {
            DOM.addExerciseForm.reportValidity();
            return;
          }
          const name = DOM.newExerciseInputs.name.value.trim();
          if (State.get().exercises.some(ex => ex.name.toLowerCase() === name.toLowerCase())) {
            UI.showDialog({ title: 'Duplicate Exercise', message: `An exercise with the name "${name}" already exists.`, confirmText: 'OK', showCancel: false });
            return;
          }
          const newExercise = { id: State.generateId('ex'), name, category: DOM.newExerciseInputs.category.value, type: DOM.newExerciseInputs.type.value, notes: DOM.newExerciseInputs.notes.value.trim() };
          State.addExercise(newExercise);
          State.setEditingExercise(null, newExercise.category);
          State.setFilter('');
          State.save();
          DOM.addExerciseForm.reset();
          DOM.newExerciseInputs.name.focus();
          UI.render();
          UI.announce(`${name} added successfully.`);
        },
        handleManageListClick(event) {
          const button = event.target.closest('button[data-action]');
          if (!button) {
            return;
          }
          const { action, exerciseId } = button.dataset;
          const exercise = State.get().exercises.find(ex => ex.id === exerciseId);
          const actionHandlers = {
            edit: () => {
              State.setEditingExercise(exerciseId, exercise.category);
              UI.renderManageExerciseList();
            },
            cancel: () => {
              State.setKeepCategoryOpen(exercise.category);
              State.setEditingExercise(null, null);
              UI.renderManageExerciseList();
            },
            save: () => {
              const newName = DOM.manageExerciseList.querySelector(`#edit-exercise-name-${exerciseId}`).value.trim();
              const newCategory = DOM.manageExerciseList.querySelector(`#edit-exercise-category-${exerciseId}`).value;
              if (!newName || State.get().exercises.some(ex => ex.id !== exerciseId && ex.name.toLowerCase() === newName.toLowerCase())) {
                UI.showDialog({ title: 'Invalid Name', message: 'Exercise name cannot be empty or a duplicate.', confirmText: 'OK', showCancel: false });
                return;
              }
              State.updateExercise(exerciseId, { name: newName, category: newCategory, type: DOM.manageExerciseList.querySelector(`#edit-exercise-type-${exerciseId}`).value, notes: DOM.manageExerciseList.querySelector(`#edit-exercise-notes-${exerciseId}`).value.trim() });
              State.setKeepCategoryOpen(newCategory);
              State.setEditingExercise(null, null);
              State.save();
              UI.renderManageExerciseList();
              UI.announce(`${newName} saved successfully.`);
            },
            delete: () => {
              UI.showDialog({ title: `Delete ${exercise.name}?`, message: 'This will also remove its history. This action cannot be undone.', confirmText: 'Delete' })
                .then(confirmed => {
                  if (confirmed) {
                    State.deleteExercise(exerciseId);
                    State.save();
                    UI.render();
                    UI.announce(`${exercise.name} deleted.`);
                  }
                });
            }
          };
          if (actionHandlers[action]) {
            actionHandlers[action]();
          }
        },
        handleSettingsFilterInput(event) {
          State.setFilter(event.target.value);
          State.setEditingExercise(null, null);
          State.setKeepCategoryOpen(null); // <-- CORRECT: Reset temporary state on new filter action
          UI.renderManageExerciseList();
        },
        handleMenuToggle(event) {
          event.stopPropagation();
          const isExpanded = DOM.manageExercisesMenu.classList.contains('show');
          DOM.manageExercisesMenu.classList.toggle('show');
          DOM.manageExercisesMenuToggle.setAttribute('aria-expanded', !isExpanded);
        },
        handleOutsideClick(event) {
          if (!event.target.closest('.dropdown')) {
            DOM.manageExercisesMenu.classList.remove('show');
            DOM.manageExercisesMenuToggle.setAttribute('aria-expanded', 'false');
          }
        },
        handleResetExercises() {
          DOM.manageExercisesMenu.classList.remove('show');
          DOM.manageExercisesMenuToggle.setAttribute('aria-expanded', 'false');
          
          UI.showDialog({
            title: 'Reset to Default Exercises?',
            message: 'This will replace all current exercises with the default set. All custom exercises and history will be permanently deleted. This cannot be undone.',
            confirmText: 'Reset'
          }).then(confirmed => {
            if (confirmed) {
              // Clear exercises and history
              State.get().exercises = [];
              State.get().history = [];
              
              // Reload the initial state to get default exercises
              const initialState = State._getInitialState(1);
              State.get().exercises = initialState.exercises;
              State.get()._nextId = initialState._nextId;
              
              State.save();
              UI.render();
              UI.announce('Exercises reset to defaults successfully.');
            }
          });
        }
      };

      // ===================================================================================
      // APP INITIALIZATION
      // ===================================================================================
      const App = {
        init() {
          State.init();
          DOM.init();
          Events.init();
          UI.render();
        }
      };

      App.init();
    });
  </script>
</body>

</html>